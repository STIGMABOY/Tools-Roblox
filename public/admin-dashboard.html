<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Robin Cookie Checker</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Admin Dashboard -->
        <div id="adminDashboard">
            <!-- Header -->
            <header class="dashboard-header">
                <div class="header-left">
                    <div class="brand">
                        <i class="fas fa-user-shield"></i>
                        <div>
                            <h1>Admin Dashboard</h1>
                            <p class="subtitle">Robin Cookie Checker Management</p>
                        </div>
                    </div>
                </div>
                
                <div class="header-right">
                    <div class="user-widget">
                        <div class="user-avatar" style="background: linear-gradient(135deg, #f39c12, #d35400);">
                            <i class="fas fa-user-cog"></i>
                        </div>
                        <div class="user-info">
                            <span class="username" id="adminName">Administrator</span>
                            <span class="user-status">Super Admin</span>
                        </div>
                        <button id="logoutBtn" class="btn-logout">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </header>

            <!-- Stats -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalUsers">0</h3>
                        <p>Total Users</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="activeUsers">0</h3>
                        <p>Active Users</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                        <i class="fas fa-user-times"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="expiredUsers">0</h3>
                        <p>Expired Users</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f39c12, #d35400);">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="serverTime">--:--:--</h3>
                        <p>Server Time</p>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="dashboard-content">
                <!-- Left Column -->
                <div class="content-left">
                    <!-- Create User Form -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-user-plus"></i> Create New User</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" id="newUsername" placeholder="Enter username">
                            </div>
                            
                            <div class="form-group">
                                <label>Password</label>
                                <input type="text" id="newPassword" placeholder="Enter password">
                                <button id="generatePass" class="btn-small">
                                    <i class="fas fa-key"></i> Generate
                                </button>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Duration (Days)</label>
                                    <select id="userDays">
                                        <option value="1">1 Day</option>
                                        <option value="7">7 Days</option>
                                        <option value="30" selected>30 Days</option>
                                        <option value="90">90 Days</option>
                                        <option value="365">365 Days</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Plan</label>
                                    <select id="userPlan">
                                        <option value="basic">Basic</option>
                                        <option value="premium">Premium</option>
                                        <option value="ultimate">Ultimate</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button id="createUserBtn" class="btn-primary">
                                <i class="fas fa-user-plus"></i> Create User
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                        </div>
                        <div class="card-body">
                            <div class="action-buttons">
                                <button id="refreshData" class="btn-action">
                                    <i class="fas fa-sync-alt"></i> Refresh Data
                                </button>
                                <button id="exportUsers" class="btn-action">
                                    <i class="fas fa-file-export"></i> Export Users
                                </button>
                                <button id="testAPI" class="btn-action">
                                    <i class="fas fa-vial"></i> Test API
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column -->
                <div class="content-right">
                    <!-- Users List -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-users"></i> User Management</h3>
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchUsers" placeholder="Search users...">
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Username</th>
                                            <th>Plan</th>
                                            <th>Status</th>
                                            <th>Expires</th>
                                            <th>Days Left</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTable">
                                        <!-- Users will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="dashboard-footer">
                <p>Admin Panel v1.0 • © 2024 Robin Cookie Checker</p>
            </footer>
        </div>

        <!-- Login Screen (hidden when logged in) -->
        <div id="loginScreen" class="login-container" style="display: none;">
            <div class="login-box">
                <div class="logo">
                    <div class="logo-icon" style="background: linear-gradient(135deg, #f39c12, #d35400);">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <h1>Admin Login</h1>
                    <p class="tagline">Robin Cookie Checker Administration</p>
                </div>
                
                <div class="login-form">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Username</label>
                        <input type="text" id="loginUsername" placeholder="admin" value="admin">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter password" value="admin123">
                    </div>
                    
                    <div id="loginError" class="error-message" style="display: none;"></div>
                    
                    <button id="loginBtn" class="btn-login">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <a href="/" style="color: #4cc9f0;">
                            <i class="fas fa-arrow-left"></i> Back to User Login
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script>
    // Admin Dashboard Script
    const ADMIN_TOKEN_KEY = 'admin_auth_token';
    
    let adminToken = localStorage.getItem(ADMIN_TOKEN_KEY);
    
    // Check authentication
    if (!adminToken) {
        showLoginScreen();
    } else {
        showDashboard();
        loadDashboardData();
    }
    
    function showLoginScreen() {
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('adminDashboard').style.display = 'none';
    }
    
    function showDashboard() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';
    }
    
    // Login function
    document.getElementById('loginBtn').addEventListener('click', async function() {
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;
        
        if (!username || !password) {
            showError('Please enter username and password');
            return;
        }
        
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
        btn.disabled = true;
        
        try {
            const response = await fetch('/api/admin/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            
            const result = await response.json();
            
            if (result.success && result.token) {
                adminToken = result.token;
                localStorage.setItem(ADMIN_TOKEN_KEY, result.token);
                showToast('Login successful!', 'success');
                showDashboard();
                loadDashboardData();
            } else {
                showError(result.error || 'Login failed');
            }
        } catch (error) {
            showError('Network error: ' + error.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });
    
    // Load dashboard data
    async function loadDashboardData() {
        try {
            const response = await fetch('/api/admin/dashboard', {
                headers: {
                    'Authorization': 'Bearer ' + adminToken
                }
            });
            
            if (response.status === 401) {
                localStorage.removeItem(ADMIN_TOKEN_KEY);
                showLoginScreen();
                return;
            }
            
            const result = await response.json();
            
            if (result.success) {
                // Update stats
                document.getElementById('totalUsers').textContent = result.stats.total_users;
                document.getElementById('activeUsers').textContent = result.stats.active_users;
                document.getElementById('expiredUsers').textContent = result.stats.expired_users;
                
                // Load users
                loadUsers();
            }
        } catch (error) {
            console.error('Error loading dashboard:', error);
        }
    }
    
    // Load users
    async function loadUsers() {
        try {
            const response = await fetch('/api/admin/users', {
                headers: {
                    'Authorization': 'Bearer ' + adminToken
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                const table = document.getElementById('usersTable');
                table.innerHTML = '';
                
                result.users.forEach(user => {
                    const row = document.createElement('tr');
                    
                    const status = user.active ? 
                        '<span class="status-badge active">Active</span>' : 
                        '<span class="status-badge expired">Expired</span>';
                    
                    const plan = `<span class="plan-badge ${user.plan}">${user.plan}</span>`;
                    
                    const daysLeft = user.days_left > 0 ? 
                        `${user.days_left} days` : 'Expired';
                    
                    row.innerHTML = `
                        <td><strong>${user.username}</strong></td>
                        <td>${plan}</td>
                        <td>${status}</td>
                        <td>${user.expiry_date}</td>
                        <td>${daysLeft}</td>
                        <td>
                            <button class="btn-small" onclick="renewUser('${user.username}')">
                                <i class="fas fa-calendar-plus"></i>
                            </button>
                            <button class="btn-small btn-danger" onclick="deleteUser('${user.username}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    table.appendChild(row);
                });
            }
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }
    
    // Create user
    document.getElementById('createUserBtn').addEventListener('click', async function() {
        const username = document.getElementById('newUsername').value.trim();
        const password = document.getElementById('newPassword').value;
        const days = document.getElementById('userDays').value;
        const plan = document.getElementById('userPlan').value;
        
        if (!username || !password) {
            showToast('Please fill all fields', 'error');
            return;
        }
        
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
        btn.disabled = true;
        
        try {
            const response = await fetch('/api/admin/create_user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + adminToken
                },
                body: JSON.stringify({
                    username,
                    password,
                    days: parseInt(days),
                    plan
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(`User ${username} created successfully`, 'success');
                document.getElementById('newUsername').value = '';
                document.getElementById('newPassword').value = '';
                loadDashboardData();
            } else {
                showToast(result.error || 'Failed to create user', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });
    
    // Generate password
    document.getElementById('generatePass').addEventListener('click', function() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let password = '';
        for (let i = 0; i < 10; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById('newPassword').value = password;
    });
    
    // Logout
    document.getElementById('logoutBtn').addEventListener('click', function() {
        localStorage.removeItem(ADMIN_TOKEN_KEY);
        adminToken = null;
        showToast('Logged out successfully', 'info');
        showLoginScreen();
    });
    
    // Refresh data
    document.getElementById('refreshData').addEventListener('click', function() {
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        
        loadDashboardData().then(() => {
            btn.innerHTML = originalText;
            showToast('Data refreshed successfully', 'success');
        });
    });
    
    // Search users
    document.getElementById('searchUsers').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#usersTable tr');
        
        rows.forEach(row => {
            const username = row.cells[0]?.textContent?.toLowerCase() || '';
            if (username.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
    
    // Renew user function
    async function renewUser(username) {
        const days = prompt(`Extend subscription for ${username} (days):`, '30');
        if (!days || isNaN(days) || parseInt(days) <= 0) return;
        
        try {
            const response = await fetch('/api/admin/renew_user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + adminToken
                },
                body: JSON.stringify({
                    username,
                    days: parseInt(days)
                })
            });
            
            const result = await response.json();
            if (result.success) {
                showToast(`User ${username} renewed for ${days} days`, 'success');
                loadDashboardData();
            } else {
                showToast(result.error || 'Failed to renew user', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }
    
    // Delete user function
    async function deleteUser(username) {
        if (!confirm(`Are you sure you want to delete user ${username}?`)) return;
        
        try {
            const response = await fetch('/api/admin/delete_user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + adminToken
                },
                body: JSON.stringify({ username })
            });
            
            const result = await response.json();
            if (result.success) {
                showToast(`User ${username} deleted successfully`, 'success');
                loadDashboardData();
            } else {
                showToast(result.error || 'Failed to delete user', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }
    
    // Export users
    document.getElementById('exportUsers').addEventListener('click', async function() {
        try {
            const response = await fetch('/api/admin/export_users', {
                headers: {
                    'Authorization': 'Bearer ' + adminToken
                }
            });
            
            const result = await response.json();
            if (result.success && result.data) {
                const dataStr = JSON.stringify(result.data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = 'users_export.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showToast('Users exported successfully', 'success');
            }
        } catch (error) {
            showToast('Error exporting users: ' + error.message, 'error');
        }
    });
    
    // Test API
    document.getElementById('testAPI').addEventListener('click', async function() {
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        
        try {
            const response = await fetch('/api/admin/test', {
                headers: {
                    'Authorization': 'Bearer ' + adminToken
                }
            });
            
            const result = await response.json();
            if (result.success) {
                showToast('API connection successful', 'success');
            } else {
                showToast('API test failed', 'error');
            }
        } catch (error) {
            showToast('API error: ' + error.message, 'error');
        } finally {
            btn.innerHTML = originalText;
        }
    });
    
    // Server time update
    function updateServerTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('id-ID', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        document.getElementById('serverTime').textContent = timeString;
    }
    
    // Update time every second
    setInterval(updateServerTime, 1000);
    updateServerTime();
    
    // Auto-refresh data every 30 seconds
    setInterval(() => {
        if (adminToken) {
            loadDashboardData();
        }
    }, 30000);
    
    // Toast notification function
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast ' + type;
        toast.style.display = 'block';
        
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }
    
    // Show error function
    function showError(message) {
        const errorDiv = document.getElementById('loginError');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }
});
